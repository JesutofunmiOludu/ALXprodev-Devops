#!/bin/bash

# --- Configuration Section ---
POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
API_BASE_URL="https://pokeapi.co/api/v2/pokemon/"
OUTPUT_DIR="pokemon_data"

# --- Function to Handle Fetching (The core worker) ---
# Functions are the key to clean parallel processing in Bash.
fetch_pokemon_data() {
    local POKEMON_NAME="$1" # Get the Pokémon name passed as the first argument
    local OUTPUT_FILE="${OUTPUT_DIR}/${POKEMON_NAME}.json"
    local API_URL="${API_BASE_URL}${POKEMON_NAME}"
    
    echo "Starting background fetch for: ${POKEMON_NAME} (PID: $$)"
    
    # Fetch the data. We rely on the API for rate limiting/errors here.
    # Note: We keep the fetch simple in this parallel version for speed.
    curl -sS "${API_URL}" -o "${OUTPUT_FILE}"
    
    # Check the exit code of curl
    if [ $? -eq 0 ]; then
        echo "Finished successfully: ${POKEMON_NAME} saved to ${OUTPUT_FILE} ✅"
    else
        echo "Finished with error: Failed to fetch ${POKEMON_NAME}. ❌"
        # Clean up the file if the download failed
        rm -f "${OUTPUT_FILE}"
    fi
}

# --- Main Script Execution ---

# 1. Create output directory if it doesn't exist
mkdir -p "${OUTPUT_DIR}"

# 2. Check if the 'curl' command is available
if ! command -v curl &> /dev/null
then
    echo "Error: 'curl' command is required but not found. Please install it."
    exit 1
fi

echo "--- Starting Parallel Data Retrieval ---"

# 3. Loop through the list and start processes in the background
for POKEMON_NAME in "${POKEMON_LIST[@]}"; do
    # Execute the function in a subshell and move it to the background
    fetch_pokemon_data "${POKEMON_NAME}" &
done

# 4. Wait for all background jobs to complete
echo "Waiting for all parallel jobs to finish..."
wait

echo "--- Parallel Fetching Complete ---"
